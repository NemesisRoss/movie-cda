name: Symfony 8 + Cypress E2E Tests

on:
    push:
        branches: [ main, test ]
    pull_request:
        branches: [ main, test ]
jobs:
    Symfony-test:
        runs-on: ubuntu-latest
        # installation des services
        services:
            mysql:
                image: mysql:8.0
                env:
                    MYSQL_ROOT_PASSWORD: root
                    MYSQL_DATABASE: app
                ports:
                    - 3306:3306
                options: >-
                    --health-cmd="mysqladmin ping -h localhost"
                    --health-interval=10s
                    --health-timeout=5s
                    --health-retries=5
        steps:
            # rÃ©cupÃ©ration du code du repository
            - name: Checkout code
              uses: actions/checkout@v4
            
            # configuration de PHP
            - name: Set up PHP
              uses: shivammathur/setup-php@v2
              with:
                php-version: "8.4"
                extensions: mbstring, intl, pdo_mysql, sodium
                tools: composer  
            
            # paramÃ©trage de l'environnement de test
            # crÃ©ation des clÃ©s privÃ© et publique
            - name: crÃ©ation des clÃ©s OpenSSL public + private
              run: |
                mkdir -p config/jwt
                openssl genpkey -out config/jwt/private.pem -aes256 -algorithm rsa -pkeyopt rsa_keygen_bits:4096 -pass pass:masupercle
                openssl pkey -in config/jwt/private.pem -out config/jwt/public.pem -pubout -passin pass:masupercle
            # configuration du fichier .env pour les tests
            - name: Set up .env for CI
              run: |
                cp .env .env.test
                echo "APP_ENV=test" >> .env
                echo "APP_ENV=test" >> .env.test
                echo "DATABASE_URL=mysql://root:root@127.0.0.1:3306/app" >> .env.test
                echo "JWT_PASSPHRASE=masupercle" >> .env.test

            - name: Create test database
              run: |
                mysql -h 127.0.0.1 -uroot -proot -e "CREATE DATABASE IF NOT EXISTS app_test;"

            # installation des dÃ©pendances Symfony
            - name: Install PHP dependencies
              run: composer install --no-interaction --prefer-dist
            # migration de la base de donnÃ©es
            - name: migration DB
              run: |
                php bin/console d:m:m
            
            # dÃ©marrage du serveur Symfony
            - name: Run Symfony local server
              run: |
                php -S 127.0.0.1:8000 -t public &
            
            # Cypress Actions
            - name : Test Cypress
              uses: cypress-io/github-action@v6
        
            - uses: actions/upload-artifact@v6
            # add the line below to store screenshots only on failures
            # if: failure()
              with:
                name: cypress-screenshots
                path: cypress/screenshots
                if-no-files-found: ignore # 'warn' or 'error' are also available, defaults to `warn`
            - uses: actions/upload-artifact@v6
              with:
                name: cypress-videos
                path: cypress/videos
                if-no-files-found: ignore # 'warn' or 'error' are also available, defaults to `warn`
  # Job de deploiement par FTP
    deploy:
      needs: Symfony-test
      runs-on: ubuntu-latest
      steps:
        # Checkout du code(rÃ©cupÃ©ration depuis le repo github)
        - name: Checkout
          uses: actions/checkout@v4
        
        # build env.php for prod
        - name: Build env.php for the app prod
          run: |
            cat > env.php <<'PHP'
            <?php
            const BDD_LOGIN = "${{ secrets.BDD_LOGIN }}";
            const BDD_PASSWORD = "${{ secrets.BDD_PASSWORD }}";
            const BDD_SERVER = "${{ secrets.BDD_SERVER }}";
            const BDD_NAME = "${{ secrets.BDD_LOGIN }}";
            const BASE_URL = "/";
            PHP
        
        # Deployment via FTP
        - name: ðŸ“‚ Deployment to FTP
          uses: SamKirkland/FTP-Deploy-Action@v4.3.6
          with:
            server: ${{ secrets.FTP_SERVER }}
            username: ${{ secrets.FTP_USERNAME }}
            password: ${{ secrets.FTP_PASSWORD }}